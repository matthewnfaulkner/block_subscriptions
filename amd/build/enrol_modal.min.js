/**
 * This module provides the course copy modal from the course and
 * category management screen.
 *
 * @module     format_apoapage/copy_modal
 * @copyright  2020 onward The Moodle Users Association <https://moodleassociation.org/>
 * @author     Matt Porritt <mattp@catalyst-au.net>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @since      3.9
 */
define("block_subscriptions/enrol_modal",["jquery","core/str","core/modal_factory","core/ajax","core/fragment","core/notification"],(function($,Str,ModalFactory,ajax,Fragment,Notification){var contextid,enrolId,subscriptionId,course,modalObj,plugin,CancelModal={},spinner='<p class="text-center"><i class="fa fa-spinner fa-pulse fa-2x fa-fw"></i></p>';function createModal(){Str.get_string("loading").then((function(title){ModalFactory.create({type:ModalFactory.types.DEFAULT,title:title,body:spinner,large:!0}).done((function(modal){(modalObj=modal).getRoot().on("click","#id_submitbutton",(function(e){e.formredirect=!0,function(e){e.preventDefault(),console.log("herer");var cancelform=modalObj.getRoot().find("form").serialize(),invalid=$.merge(modalObj.getRoot().find('[aria-invalid="true"]'),modalObj.getRoot().find(".error"));if(invalid.length)return void invalid.first().focus();ajax.call([{methodname:"block_subscriptions_submit_user_enrolment_form",args:{formdata:cancelform}}])[0].done((function(response){var result=response;console.log(response.result),result.result?(modalObj.setBody(spinner),modalObj.hide(),window.location.reload()):updateModalBody(cancelform)})).fail((function(fail){console.log(fail),updateModalBody(cancelform)}))}(e)})),modalObj.getRoot().on("click","#id_cancel",(function(e){e.preventDefault(),modalObj.setBody(spinner),modalObj.hide()}))}))})).catch((function(){Notification.exception(new Error("Failed to load string: loading"))}))}function updateModalBody(formdata){if(void 0===formdata&&(formdata={}),void 0!==enrolId&&void 0!==enrolId){var params={jsonformdata:JSON.stringify(formdata),plugin:plugin,enrolid:enrolId};modalObj.setBody(spinner),Str.get_string("subscribetitle","block_subscriptions",course.shortname).then((function(title){modalObj.setTitle(title),modalObj.setBody(Fragment.loadFragment("block_subscriptions","new_enrol_form",contextid,params))})).catch((function(){Notification.exception(new Error("Failed to load string: copycoursetitle"))}))}}return CancelModal.init=function(context,subscription){contextid=context,subscriptionId=subscription,createModal(),$(".action-subscribe-"+subscriptionId).on("click",(function(e){modalObj.setBody(spinner),e.preventDefault();let url=new URL(this.getAttribute("href")),params=new URLSearchParams(url.search);enrolId=params.get("enrolid"),plugin=params.get("plugin");let courseId=params.get("id");null!==courseId?ajax.call([{methodname:"core_course_get_courses",args:{options:{ids:[courseId]}}}])[0].done((function(response){course=response[0],updateModalBody()})).fail((function(){Notification.exception(new Error("Failed to load course"))})):updateModalBody(),modalObj.show()}))},CancelModal}));

//# sourceMappingURL=enrol_modal.min.js.map